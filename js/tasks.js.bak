// === æ¥å£é…ç½® ===
const API_CONFIG = {
  task: "https://ban-api-puce.vercel.app/api/tasks",
  fit: "https://ban-api-puce.vercel.app/api/banFits",
};

// æ¯ä¸ªåˆ—è¡¨ç»´æŠ¤ç‹¬ç«‹çš„æ•°æ®
const allTasks = {
  task: [],
  fit: []
};

// åŠ è½½ä»»åŠ¡
async function loadTasks(listId) {
  try {
    const res = await fetch(API_CONFIG[listId]);
    allTasks[listId] = await res.json();
    renderTasks(listId);
  } catch (err) {
    console.error(`åŠ è½½ ${listId} å¤±è´¥:`, err);
  }
}

// æ¸²æŸ“ä»»åŠ¡
function renderTasks(listId) {
  const container = document.getElementById(`task-list-${listId}`);
  if (!container) return;

  const tasks = allTasks[listId];
  const rootTasks = tasks.filter(t => !t.parentId);
  const activeTasks = rootTasks.filter(t => !t.checked && !t.deleted);
  const completedTasks = rootTasks.filter(t => t.checked && !t.deleted);
  const deletedTasks = rootTasks.filter(t => t.deleted);

  container.innerHTML = `
    ${activeTasks.length ? '<h3>æœªå®Œæˆ</h3>' + renderTree(activeTasks, listId) : ''}
    ${completedTasks.length ? '<h3>å·²å®Œæˆ</h3>' + renderTree(completedTasks, listId) : ''}
    ${deletedTasks.length ? '<h3>å·²åˆ é™¤</h3>' + renderTree(deletedTasks, listId) : ''}
  `;
}

// é€’å½’æ¸²æŸ“æ ‘
function renderTree(list, listId, parentDeleted = false) {
  if (!list || !list.length) return '';

  return `
    <ul>
      ${list.map(task => {
        const isDeleted = parentDeleted || task.deleted; // è‹¥çˆ¶çº§è¢«åˆ é™¤ï¼Œå­çº§ä¹Ÿè§†ä¸ºåˆ é™¤
        return `
          <li>
            <div class="task-item ${isDeleted ? 'deleted' : ''}">
              <input type="checkbox" ${task.checked ? 'checked' : ''}
                     onchange="toggleTask('${task._id}', this.checked, '${listId}')">
              <input class="task-title" value="${task.title}"
                     onblur="editTask('${task._id}', this.value, '${listId}')">
              <div class="task-actions">
                ${task.deleted
                  ? `<button onclick="restoreTask('${task._id}', '${listId}')">â†©ï¸</button>`
                  : `<button onclick="softDeleteTask('${task._id}', '${listId}')">ğŸ—‘</button>`}
                <button onclick="realDeleteTask('${task._id}', '${listId}')">âŒ</button>
                <button onclick="showSubTaskInput('${task._id}', '${listId}')">â•</button>
              </div>
              <div id="subtask-input-${task._id}" style="margin-left:30px;"></div>
            </div>
            ${renderTree(allTasks[listId].filter(t => t.parentId === task._id), listId, isDeleted)}
          </li>
        `;
      }).join('')}
    </ul>
  `;
}


// æ›´æ–°æœ¬åœ°ç¼“å­˜å’Œ API
async function updateTaskField(id, fields, listId) {
  const task = allTasks[listId].find(t => t._id === id);
  if (task) Object.assign(task, fields);
  renderTasks(listId);

  await fetch(API_CONFIG[listId], {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ _id: id, ...fields })
  });
}

// æ“ä½œå‡½æ•°
function toggleTask(id, checked, listId) { return updateTaskField(id, { checked }, listId); }
function editTask(id, title, listId) { return updateTaskField(id, { title }, listId); }
function softDeleteTask(id, listId) { return updateTaskField(id, { deleted: true }, listId); }
function restoreTask(id, listId) { return updateTaskField(id, { deleted: false }, listId); }

// çœŸå®åˆ é™¤ï¼ˆæ”¯æŒåˆ é™¤å­ä»»åŠ¡ï¼‰
async function realDeleteTask(id, listId) {
  if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ä»»åŠ¡åŠå…¶æ‰€æœ‰å­ä»»åŠ¡å—ï¼Ÿ")) return;

  // è·å–æ‰€æœ‰éœ€è¦åˆ é™¤çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬å­ä»»åŠ¡
  const getAllChildrenIds = (parentId) => {
    const children = allTasks[listId].filter(t => t.parentId === parentId);
    let ids = children.map(c => c._id);
    for (const c of children) {
      ids = ids.concat(getAllChildrenIds(c._id));
    }
    return ids;
  };

  const allIdsToDelete = [id, ...getAllChildrenIds(id)];

  // ä»æœ¬åœ°ç¼“å­˜åˆ é™¤
  allTasks[listId] = allTasks[listId].filter(t => !allIdsToDelete.includes(t._id));
  renderTasks(listId);

  // å‘é€åˆ é™¤è¯·æ±‚
  try {
    for (const delId of allIdsToDelete) {
      await fetch(API_CONFIG[listId], {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ _id: delId, action: "delete" })
      });
    }
    console.log(`âœ… å·²åˆ é™¤ ${allIdsToDelete.length} æ¡ä»»åŠ¡`);
  } catch (err) {
    console.error("åˆ é™¤å¤±è´¥:", err);
    alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
  }
}


// æ–°å¢ä»»åŠ¡
async function addTask(listId) {
  const input = document.getElementById(`new-task-title-${listId}`);
  const title = input.value.trim();
  if (!title) return alert("è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜");

  const res = await fetch(API_CONFIG[listId], {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, parentId: null, level: 0 })
  });
  const data = await res.json();
  allTasks[listId].push({ _id: data._id, title, checked: false, deleted: false, parentId: null, level: 0 });
  input.value = '';
  renderTasks(listId);
}

// æ–°å¢å­ä»»åŠ¡
async function addSubTask(parentId, listId) {
  const input = document.getElementById(`new-subtask-${parentId}`);
  const title = input.value.trim();
  if (!title) return alert("è¯·è¾“å…¥å­ä»»åŠ¡æ ‡é¢˜");

  const parent = allTasks[listId].find(t => t._id === parentId);
  const level = parent ? parent.level + 1 : 1;

  const res = await fetch(API_CONFIG[listId], {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, parentId, level })
  });
  const data = await res.json();
  allTasks[listId].push({ _id: data._id, title, checked: false, deleted: false, parentId, level });
  input.value = '';
  renderTasks(listId);
}

// æ˜¾ç¤ºå­ä»»åŠ¡è¾“å…¥æ¡†
function showSubTaskInput(parentId, listId) {
  const div = document.getElementById(`subtask-input-${parentId}`);
  if (div.innerHTML.trim()) return;
  div.innerHTML = `
    <input id="new-subtask-${parentId}" placeholder="å­ä»»åŠ¡æ ‡é¢˜">
    <button onclick="addSubTask('${parentId}', '${listId}')">æ–°å¢</button>
  `;
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸¤ä¸ªåˆ—è¡¨
document.addEventListener("DOMContentLoaded", () => {
  loadTasks('task');
  loadTasks('fit');
});


// === ä¸€é”®å¯¼å…¥30å¤©å¥èº«è®¡åˆ’ï¼ˆçˆ¶å­ç»“æ„ï¼‰===
const fitnessPlan = [
  { date: 'â°10/27', time: 'æ—©ä¸Š 7:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: 'æ…¢è·‘ 30 åˆ†é’Ÿï¼ˆè½»æ¾å‘¼å¸ï¼‰', notes: 'æ—©é¤é«˜è›‹ç™½ï¼Œæ™šé¤æ¸…æ·¡ï¼Œç¡çœ  7â€“8h' },
  { date: 'â°10/28', time: 'æ™šä¸Š 21:00', type: 'ğŸ”¥ è·³ç»³', duration: 'é—´æ­‡è·³ç»³ 15 åˆ†é’Ÿ Ã—2ç»„ï¼Œé—´éš”1åˆ†é’Ÿ', notes: 'å¤šå–æ°´ï¼Œå°‘æ²¹ç‚¸é£Ÿå“' },
  { date: 'â°10/29', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'ä¿è¯æ·±åº¦ç¡çœ ï¼Œé€‚é‡æ‹‰ä¼¸' },
  { date: 'â°10/30', time: 'æ—©ä¸Š 6:30', type: 'ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯', duration: '2 ç»„ Ã— 10 å±‚ï¼Œæ…¢é€Ÿ', notes: 'æ—©é¤è”¬èœ+è›‹ç™½ï¼Œç¡å‰å°‘å’–å•¡å› ' },
  { date: 'â°10/31', time: 'æ—©ä¸Š 7:00', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '30 åˆ†é’Ÿæ²¿æ±Ÿç»¿é“ï¼Œè½»æ¾é€Ÿåº¦', notes: 'è¡¥å……æ°´åˆ†ï¼Œæ™šé¤å°‘ç¢³æ°´' },
  { date: 'â°11/1', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾ã€æ‹‰ä¼¸ã€æ—©ç¡' },
  { date: 'â°11/2', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾ã€æ‹‰ä¼¸ã€æ—©ç¡' },
  { date: 'â°11/3', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾ã€æ‹‰ä¼¸ã€æ—©ç¡' },
  { date: 'â°11/4', time: 'æ—©ä¸Š 7:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: '35 åˆ†é’Ÿæ…¢è·‘', notes: 'æ—©é¤åŠ ç‡•éº¦ï¼Œä¿æŒæ°´åˆ†' },
  { date: 'â°11/5', time: 'æ™šä¸Š 21:00', type: 'ğŸ”¥ è·³ç»³+ğŸ§—â€â™‚ï¸ æ¥¼æ¢¯', duration: 'è·³ç»³ 15 åˆ†é’Ÿï¼Œçˆ¬æ¥¼æ¢¯ 1 ç»„ Ã— 12 å±‚', notes: 'æ™šé¤è›‹ç™½é€‚é‡ï¼Œç¡å‰æ‹‰ä¼¸' },
  { date: 'â°11/6', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾è‚Œè‚‰ï¼Œä¿è¯ç¡çœ ' },
  { date: 'â°11/7', time: 'æ—©ä¸Š 6:30', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '35 åˆ†é’Ÿï¼Œé€‚åº¦åŠ é€Ÿ', notes: 'æ—©é¤è›‹ç™½+æ°´æœï¼Œæ™šé¤æ¸…æ·¡' },
  { date: 'â°11/8', time: 'æ™šä¸Š 21:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: '30 åˆ†é’Ÿæ…¢è·‘ + 5 åˆ†é’Ÿå†²åˆº', notes: 'æ°´åˆ†å……è¶³ï¼Œç¡å‰æ‹‰ä¼¸' },
  { date: 'â°11/9', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾ä¸è¡¥æ°´' },
  { date: 'â°11/10', time: 'æ—©ä¸Š 7:00', type: 'ğŸ”¥ è·³ç»³', duration: 'é—´æ­‡è·³ç»³ 20 åˆ†é’Ÿ Ã—2ç»„', notes: 'æ—©é¤è›‹ç™½+å¤åˆç¢³æ°´' },
  { date: 'â°11/11', time: 'æ™šä¸Š 21:00', type: 'ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯', duration: '2â€“3 ç»„ Ã— 12 å±‚', notes: 'æ™šé¤å°‘ç›ï¼Œä¿è¯ç¡çœ ' },
  { date: 'â°11/12', time: 'æ—©ä¸Š 6:30', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '40 åˆ†é’Ÿ', notes: 'æ—©é¤åŠ è›‹ç™½ï¼Œç¡çœ  7â€“8h' },
  { date: 'â°11/13', time: 'æ™šä¸Š 21:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: '35 åˆ†é’Ÿæ…¢è·‘ + 5 åˆ†é’Ÿå†²åˆº', notes: 'æ°´åˆ†å……è¶³ï¼Œæ™šé¤æ¸…æ·¡' },
  { date: 'â°11/14', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾è‚Œè‚‰ï¼Œé€‚å½“æ‹‰ä¼¸' },
  { date: 'â°11/15', time: 'æ—©ä¸Š 7:00', type: 'ğŸ”¥ è·³ç»³+ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯', duration: 'è·³ç»³ 15 åˆ†é’Ÿ + çˆ¬æ¥¼æ¢¯ 2 ç»„ Ã— 15 å±‚', notes: 'æ—©é¤é«˜è›‹ç™½ï¼Œæ™šé¤æ¸…æ·¡' },
  { date: 'â°11/16', time: 'æ—©ä¸Š 6:30', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '40 åˆ†é’Ÿï¼Œé€‚åº¦åŠ é€Ÿ', notes: 'æ°´æœè¡¥å……ç»´ç”Ÿç´ ' },
  { date: 'â°11/17', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾è‚Œè‚‰ï¼Œæ·±åº¦ç¡çœ ' },
  { date: 'â°11/18', time: 'æ—©ä¸Š 7:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: '40 åˆ†é’Ÿæ…¢è·‘ + 5 åˆ†é’Ÿå†²åˆº', notes: 'æ—©é¤è›‹ç™½+å¤åˆç¢³æ°´' },
  { date: 'â°11/19', time: 'æ™šä¸Š 21:00', type: 'ğŸ”¥ è·³ç»³', duration: 'é—´æ­‡è·³ç»³ 20 åˆ†é’Ÿ Ã—2ç»„', notes: 'è¡¥å……æ°´åˆ†ï¼Œæ‹‰ä¼¸' },
  { date: 'â°11/20', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾è‚Œè‚‰ï¼Œä¿è¯ç¡çœ ' },
  { date: 'â°11/21', time: 'æ—©ä¸Š 7:00', type: 'ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯', duration: '3 ç»„ Ã— 15 å±‚', notes: 'æ—©é¤é«˜è›‹ç™½' },
  { date: 'â°11/22', time: 'æ™šä¸Š 21:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥+ğŸ”¥ è·³ç»³', duration: 'è·‘æ­¥ 20 åˆ†é’Ÿ + è·³ç»³ 20 åˆ†é’Ÿ', notes: 'æ™šé¤æ¸…æ·¡' },
  { date: 'â°11/23', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'é€‚å½“æ‹‰ä¼¸ï¼Œä¿è¯ç¡çœ ' },
  { date: 'â°11/24', time: 'æ—©ä¸Š 6:30', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '45 åˆ†é’Ÿï¼Œé€‚åº¦åŠ é€Ÿ', notes: 'æ—©é¤é«˜è›‹ç™½' },
  { date: 'â°11/25', time: 'æ™šä¸Š 21:00', type: 'ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯+ğŸ”¥ è·³ç»³', duration: 'çˆ¬æ¥¼æ¢¯ 3 ç»„ Ã— 15 å±‚ + è·³ç»³ 20 åˆ†é’Ÿ', notes: 'è¡¥å……æ°´åˆ†ï¼Œæ™šé¤æ¸…æ·¡' },
  { date: 'â°11/26', time: 'ä¼‘æ¯', type: 'â€”', duration: 'â€”', notes: 'æ”¾æ¾è‚Œè‚‰ï¼Œä¿è¯ç¡çœ ' },
  { date: 'â°11/27', time: 'æ—©ä¸Š 7:00', type: 'ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: '45 åˆ†é’Ÿæ…¢è·‘ + å†²åˆº 5 åˆ†é’Ÿ', notes: 'æ—©é¤é«˜è›‹ç™½' },
  { date: 'â°11/28', time: 'æ™šä¸Š 21:00', type: 'ğŸ”¥ è·³ç»³+ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: 'è·³ç»³ 25 åˆ†é’Ÿ + è·‘æ­¥ 25 åˆ†é’Ÿ', notes: 'æ°´åˆ†å……è¶³ï¼Œç¡çœ  7â€“8h' },
  { date: 'â°11/29', time: 'æ—©ä¸Š 6:30', type: 'ğŸš´â€â™‚ï¸ éª‘è¡Œ', duration: '50 åˆ†é’Ÿ', notes: 'æ—©é¤è›‹ç™½+æ°´æœ' },
  { date: 'â°11/30', time: 'æ™šä¸Š 21:00', type: 'ğŸ§—â€â™‚ï¸ çˆ¬æ¥¼æ¢¯+ğŸƒâ€â™‚ï¸ è·‘æ­¥', duration: 'çˆ¬æ¥¼æ¢¯ 3 ç»„ Ã— 15 å±‚ + è·‘æ­¥ 20 åˆ†é’Ÿ', notes: 'æ™šé¤æ¸…æ·¡' }
];


async function importFitnessPlan() {
  let success = 0;

  for (let plan of fitnessPlan) {
    try {
      // 1çº§ï¼šæ—¥æœŸ
      const res = await fetch(API_CONFIG.fit, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: plan.date, parentId: null, level: 0 }),
      });
      const data = await res.json();
      const parentId = data._id;

      // 2çº§ï¼šæ—¶é—´ã€è¿åŠ¨ã€é¥®é£Ÿ
      const children = [
        { title: `æ—¶é—´: ${plan.time}` },
        { title: `è¿åŠ¨ç±»å‹: ${plan.type} / ${plan.duration}` },
        { title: `é¥®é£Ÿ & ç¡çœ : ${plan.notes}` }
      ];

      for (const child of children) {
        const childRes = await fetch(API_CONFIG.fit, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: child.title, parentId, level: 1 }),
        });
        const childData = await childRes.json();
        allTasks.fit.push({ _id: childData._id, title: child.title, checked: false, deleted: false, parentId, level: 1 });
      }

      // æ·»åŠ çˆ¶çº§åˆ°æœ¬åœ°ç¼“å­˜
      allTasks.fit.push({ _id: parentId, title: plan.date, checked: false, deleted: false, parentId: null, level: 0 });

      success++;
      console.log(`âœ… å·²å¯¼å…¥: ${plan.date} (${success}/${fitnessPlan.length})`);

    } catch (err) {
      console.error("âŒ å¯¼å…¥å¤±è´¥:", plan.date, err);
    }
  }

  renderTasks('fit');
  alert(`ğŸ‰ å¯¼å…¥å®Œæˆï¼æˆåŠŸå¯¼å…¥ ${success} æ¡æ—¥æœŸè®¡åˆ’ã€‚`);
}


// importFitnessPlan();